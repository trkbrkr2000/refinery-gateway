import { test, expect } from '@playwright/test';
import { authenticateUser, TEST_USERS } from '../../utils/auth';
import { apiRequest, uploadFile, waitForJobCompletion } from '../../utils/api-helpers';
import path from 'path';

test.describe('Document Extraction API', () => {
  test('extract data from PDF document', async ({ request }) => {
    // Authenticate
    const tokens = await authenticateUser(request, TEST_USERS.regular);

    // Upload test document
    const testPdfPath = path.join(__dirname, '../../fixtures/sample-va-form.pdf');
    const uploadResponse = await uploadFile(
      request,
      '/extract',
      testPdfPath,
      tokens
    );

    expect(uploadResponse.ok()).toBeTruthy();
    const uploadData = await uploadResponse.json();
    expect(uploadData).toHaveProperty('jobId');

    // Wait for extraction to complete
    const job = await waitForJobCompletion(request, uploadData.jobId, tokens);

    expect(job.status).toBe('completed');
    expect(job.result).toHaveProperty('extractedData');
  });

  test('extraction fails with invalid file type', async ({ request }) => {
    const tokens = await authenticateUser(request, TEST_USERS.regular);

    const invalidFilePath = path.join(__dirname, '../../fixtures/invalid.txt');
    const response = await uploadFile(request, '/extract', invalidFilePath, tokens);

    expect(response.status()).toBe(400);
    const error = await response.json();
    expect(error.message).toContain('Invalid file type');
  });
});